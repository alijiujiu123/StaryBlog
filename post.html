<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stary's Blog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bodoni+Moda:wght@400;500;600;700&family=Jost:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --primary: #18181B;
            --secondary: #3F3F46;
            --accent: #EC4899;
            --accent-hover: #DB2777;
            --bg: #FFFFFF;
            --surface: #F9FAFB;
            --text: #09090B;
            --text-muted: #71717A;
            --border: #E4E4E7;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Jost', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Bodoni Moda', serif;
            font-weight: 600;
            letter-spacing: -0.02em;
            color: var(--primary);
        }

        /* Reading Progress Bar */
        #progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent), #A855F7);
            width: 0%;
            z-index: 100;
            transition: width 0.1s linear;
        }

        /* Article Header */
        .article-hero {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        /* Prose Styles */
        .prose { max-width: 100%; }

        .prose h1 {
            font-size: 1.75rem;
            line-height: 1.2;
            margin-bottom: 1.25rem;
        }

        .prose h2 {
            font-size: 1.5rem;
            line-height: 1.3;
            margin-top: 2.5rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .prose h3 {
            font-size: 1.25rem;
            line-height: 1.4;
            margin-top: 2rem;
            margin-bottom: 0.5rem;
        }

        .prose h4 {
            font-size: 1.125rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }

        @media (min-width: 768px) {
            .prose h1 { font-size: 2.25rem; }
            .prose h2 { font-size: 1.75rem; margin-top: 3rem; }
            .prose h3 { font-size: 1.375rem; margin-top: 2.25rem; }
            .prose h4 { font-size: 1.25rem; }
        }

        .prose p {
            margin-bottom: 1.25rem;
            font-size: 1rem;
            color: #374151;
            line-height: 1.8;
        }

        @media (min-width: 768px) {
            .prose p { font-size: 1.0625rem; }
        }

        .prose ul, .prose ol {
            margin-bottom: 1.25rem;
            padding-left: 1.25rem;
        }

        @media (min-width: 768px) {
            .prose ul, .prose ol { padding-left: 1.5rem; }
        }

        .prose li {
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .prose ul { list-style-type: disc; }
        .prose ol { list-style-type: decimal; }

        .prose blockquote {
            border-left: 3px solid var(--accent);
            padding: 0.75rem 1rem;
            margin: 1.5rem 0;
            color: var(--text-muted);
            font-style: italic;
            font-size: 1rem;
            line-height: 1.7;
            background: var(--surface);
            border-radius: 0 0.5rem 0.5rem 0;
        }

        @media (min-width: 768px) {
            .prose blockquote {
                padding: 1rem 1.25rem;
                font-size: 1.0625rem;
                margin: 2rem 0;
            }
        }

        .prose code {
            background: #F3F4F6;
            color: #DB2777;
            padding: 0.15rem 0.4rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
        }

        .prose pre {
            background: #1E1E2E;
            padding: 1rem;
            border-radius: 0.75rem;
            overflow-x: auto;
            margin: 1.5rem 0;
            border: 1px solid #2D2D3F;
        }

        @media (min-width: 768px) {
            .prose pre {
                padding: 1.5rem;
                margin: 2rem 0;
            }
        }

        .prose pre code {
            background: transparent;
            padding: 0;
            color: #E4E4E7;
            font-size: 0.8125rem;
        }

        @media (min-width: 768px) {
            .prose pre code { font-size: 0.875rem; }
        }

        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            font-size: 0.875rem;
            display: block;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 0.5rem;
        }

        @media (min-width: 768px) {
            .prose table {
                margin: 2rem 0;
                font-size: 0.9375rem;
                display: table;
            }
        }

        .prose th, .prose td {
            border: 1px solid var(--border);
            padding: 0.625rem 0.75rem;
            text-align: left;
        }

        @media (min-width: 768px) {
            .prose th, .prose td { padding: 0.875rem 1rem; }
        }

        .prose th {
            background: var(--surface);
            font-weight: 600;
            font-family: 'Jost', sans-serif;
        }

        .prose tr:hover { background: var(--surface); }

        .prose a {
            color: var(--accent);
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s ease;
        }

        .prose a:hover { border-bottom-color: var(--accent); }

        .prose strong {
            font-weight: 600;
            color: var(--primary);
        }

        .prose hr {
            border: none;
            border-top: 1px solid var(--border);
            margin: 2rem 0;
        }

        @media (min-width: 768px) {
            .prose hr { margin: 3rem 0; }
        }

        .prose img {
            border-radius: 0.75rem;
            width: 100%;
            height: auto;
        }

        /* TOC Styles */
        #toc {
            position: sticky;
            top: 5rem;
        }

        #toc h4 {
            font-family: 'Jost', sans-serif;
            font-weight: 600;
            font-size: 0.6875rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        #toc a {
            color: var(--text-muted);
            text-decoration: none;
            display: block;
            padding: 0.3125rem 0;
            padding-left: 0.875rem;
            font-size: 0.8125rem;
            transition: all 0.2s ease;
            border-left: 2px solid var(--border);
            line-height: 1.4;
        }

        #toc a:hover {
            color: var(--primary);
            border-left-color: var(--accent);
        }

        #toc a.active {
            color: var(--accent);
            border-left-color: var(--accent);
            font-weight: 500;
        }

        #toc .toc-h2 { font-weight: 400; }

        #toc .toc-h3 {
            font-size: 0.75rem;
            padding-left: 1.5rem;
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 60vh;
            gap: 1rem;
        }

        .spinner {
            width: 28px;
            height: 28px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-text {
            font-size: 0.8125rem;
            color: var(--text-muted);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Navigation */
        .nav-link {
            position: relative;
            color: var(--text-muted);
            transition: color 0.2s ease;
        }

        .nav-link:hover { color: var(--primary); }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -0.25rem;
            left: 0;
            width: 0;
            height: 1px;
            background: var(--accent);
            transition: width 0.3s ease;
        }

        .nav-link:hover::after { width: 100%; }

        /* Mode Toggle */
        #mode-toggle {
            display: none;
            justify-content: center;
            margin-bottom: 2rem;
        }

        #mode-toggle.visible { display: flex; }

        .mode-switch {
            display: inline-flex;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            padding: 0.25rem;
            gap: 0.25rem;
        }

        .mode-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 0.875rem;
            border-radius: 0.375rem;
            font-size: 0.8125rem;
            font-weight: 500;
            font-family: 'Jost', sans-serif;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .mode-btn:hover { color: var(--primary); }

        .mode-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        /* Visual Section */
        .visual-section {
            margin: 2rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
            background: #1E1E2E;
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
            border: 1px solid #2D2D3F;
        }

        .visual-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .visual-section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #A1A1AA;
            font-size: 0.8125rem;
            font-weight: 500;
            font-family: 'Jost', sans-serif;
        }

        .visual-section-badge {
            background: var(--accent);
            color: white;
            padding: 0.1875rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.625rem;
            font-weight: 600;
            font-family: 'Jost', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .visual-iframe {
            width: 100%;
            min-height: 400px;
            border: none;
            display: block;
        }

        @media (min-width: 1024px) {
            .visual-iframe { min-height: 480px; }
        }

        /* Category Badge */
        .category-badge {
            display: inline-flex;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-family: 'Jost', sans-serif;
        }

        .category-blue { background: #DBEAFE; color: #1E40AF; }
        .category-red { background: #FEE2E2; color: #991B1B; }
        .category-green { background: #D1FAE5; color: #065F46; }
        .category-purple { background: #E9D5FF; color: #6B21A8; }
        .category-pink { background: #FCE7F3; color: #9D174D; }
        .category-yellow { background: #FEF3C7; color: #92400E; }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; }

        .hidden-content { display: none !important; }

        /* TOC containers */
        #toc-container { display: none; }

        @media (min-width: 1024px) {
            #toc-container { display: block; }
        }

        /* Mobile TOC */
        #toc-mobile {
            display: block;
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--surface);
            border-radius: 0.75rem;
            border: 1px solid var(--border);
        }

        @media (min-width: 1024px) {
            #toc-mobile { display: none; }
        }

        .toc-mobile-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 0.25rem 0;
        }

        .toc-mobile-content {
            display: none;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .toc-mobile-content.open { display: block; }

        #toc-list-mobile a {
            color: var(--text-muted);
            text-decoration: none;
            display: block;
            padding: 0.3125rem 0;
            padding-left: 0.875rem;
            font-size: 0.8125rem;
            border-left: 2px solid var(--border);
            transition: all 0.2s ease;
        }

        #toc-list-mobile a:hover {
            color: var(--primary);
            border-left-color: var(--accent);
        }

        #toc-list-mobile .toc-h3 {
            font-size: 0.75rem;
            padding-left: 1.5rem;
        }

        /* Back to top */
        #back-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 50;
        }

        #back-to-top.visible {
            opacity: 1;
            transform: translateY(0);
        }

        #back-to-top:hover {
            background: var(--accent);
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            html { scroll-behavior: auto; }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Reading Progress -->
    <div id="progress-bar"></div>

    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-zinc-200 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-14 sm:h-16 items-center">
                <a href="/" class="text-lg sm:text-xl font-semibold" style="font-family: 'Bodoni Moda', serif; color: var(--primary);">
                    Stary's Blog
                </a>
                <div class="flex items-center gap-6 sm:gap-8">
                    <a href="/" class="nav-link text-sm">首页</a>
                    <a href="/#about" class="nav-link text-sm">关于</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Loading -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <span class="loading-text">加载中</span>
    </div>

    <!-- Content -->
    <div id="content" class="hidden">
        <!-- Article Hero Header -->
        <header class="article-hero py-10 sm:py-14 md:py-20 fade-in-up">
            <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center gap-3 text-sm text-zinc-500 mb-4 sm:mb-5">
                    <a href="/" class="hover:text-zinc-800 transition-colors">首页</a>
                    <svg class="w-3.5 h-3.5 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    <span id="header-category" class="category-badge"></span>
                </div>
                <h1 id="header-title" class="text-2xl sm:text-3xl md:text-4xl lg:text-[2.75rem] leading-tight mb-4 sm:mb-6"></h1>
                <p id="header-description" class="text-base sm:text-lg text-zinc-500 leading-relaxed max-w-2xl"></p>
                <div class="flex items-center gap-3 mt-6 sm:mt-8 text-sm text-zinc-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span id="header-date"></span>
                    <span class="w-1 h-1 bg-zinc-300 rounded-full"></span>
                    <span id="header-readtime"></span>
                </div>
            </div>
        </header>

        <!-- Mode Toggle -->
        <div id="mode-toggle">
            <div class="mode-switch">
                <button onclick="showMD()" class="mode-btn" id="btn-md">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>文章</span>
                </button>
                <button onclick="showHTML()" class="mode-btn" id="btn-html">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span>可视化</span>
                </button>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 pb-16 sm:pb-24">
            <div class="flex flex-col lg:flex-row lg:gap-16">
                <!-- Article Content -->
                <main class="flex-1 min-w-0 max-w-3xl">
                    <!-- Mobile TOC -->
                    <div id="toc-mobile">
                        <div class="toc-mobile-header" onclick="toggleMobileTOC()">
                            <h4 class="font-semibold text-sm text-zinc-700" style="font-family: 'Jost', sans-serif;">
                                <span style="display:inline-flex;align-items:center;gap:0.375rem;">
                                    <svg class="w-4 h-4 text-zinc-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
                                    </svg>
                                    目录
                                </span>
                            </h4>
                            <svg id="toc-chevron" class="w-5 h-5 text-zinc-400 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <div id="toc-mobile-content" class="toc-mobile-content">
                            <div id="toc-list-mobile"></div>
                        </div>
                    </div>

                    <article id="article">
                        <div class="prose"></div>
                    </article>

                    <!-- Visual Section -->
                    <div id="visual-section" class="visual-section hidden">
                        <div class="visual-section-header">
                            <div class="visual-section-title">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                                <span>交互式可视化</span>
                            </div>
                            <span class="visual-section-badge">Interactive</span>
                        </div>
                        <iframe id="visual-iframe" class="visual-iframe" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
                    </div>
                </main>

                <!-- Desktop TOC Sidebar -->
                <aside id="toc-container" class="w-48 xl:w-52 flex-shrink-0">
                    <div id="toc">
                        <h4>目录</h4>
                        <div id="toc-list"></div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <!-- Back to top -->
    <button id="back-to-top" onclick="window.scrollTo({top:0,behavior:'smooth'})" aria-label="返回顶部">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
        </svg>
    </button>

    <!-- Footer -->
    <footer class="bg-zinc-900 text-white py-8 sm:py-12 mt-0">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-zinc-400 text-xs sm:text-sm">
                &copy; 2026 Stary's Blog
            </p>
        </div>
    </footer>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');
        const postPath = urlParams.get('post');

        if (!slug && !postPath) {
            window.location.href = '/';
        }

        let currentMode = 'md';
        let postMeta = null;

        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        const categoryColors = {
            blue: 'category-blue',
            green: 'category-green',
            red: 'category-red',
            yellow: 'category-yellow',
            purple: 'category-purple',
            pink: 'category-pink',
            indigo: 'category-purple',
            gray: 'category-blue'
        };

        function estimateReadTime(text) {
            const words = text.replace(/[#*`>\-|]/g, '').trim().split(/\s+/).length;
            const cjkChars = (text.match(/[\u4e00-\u9fff]/g) || []).length;
            const minutes = Math.ceil((words + cjkChars) / 400);
            return Math.max(1, minutes) + ' 分钟阅读';
        }

        function showMD() {
            currentMode = 'md';
            document.getElementById('article').classList.remove('hidden-content');
            document.getElementById('visual-section').classList.add('hidden');
            document.getElementById('toc-container').classList.remove('hidden');
            document.getElementById('toc-mobile').classList.remove('hidden');
            document.getElementById('btn-md').classList.add('active');
            document.getElementById('btn-html').classList.remove('active');
        }

        function showHTML() {
            currentMode = 'html';
            document.getElementById('article').classList.add('hidden-content');
            document.getElementById('visual-section').classList.remove('hidden');
            document.getElementById('toc-container').classList.add('hidden');
            document.getElementById('toc-mobile').classList.add('hidden');
            document.getElementById('btn-md').classList.remove('active');
            document.getElementById('btn-html').classList.add('active');
        }

        function toggleMobileTOC() {
            const content = document.getElementById('toc-mobile-content');
            const chevron = document.getElementById('toc-chevron');
            content.classList.toggle('open');
            chevron.classList.toggle('rotate-180');
        }

        // Reading progress bar
        function updateProgress() {
            const article = document.getElementById('article');
            if (!article || currentMode !== 'md') {
                document.getElementById('progress-bar').style.width = '0%';
                return;
            }
            const rect = article.getBoundingClientRect();
            const articleTop = rect.top + window.scrollY;
            const articleHeight = rect.height;
            const scrolled = window.scrollY - articleTop;
            const progress = Math.min(100, Math.max(0, (scrolled / (articleHeight - window.innerHeight)) * 100));
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        // Back to top button
        function updateBackToTop() {
            const btn = document.getElementById('back-to-top');
            if (window.scrollY > 400) {
                btn.classList.add('visible');
            } else {
                btn.classList.remove('visible');
            }
        }

        // TOC active state tracking
        let tocHeadings = [];

        function updateActiveTOC() {
            if (tocHeadings.length === 0) return;

            let activeId = '';
            for (const heading of tocHeadings) {
                const el = document.getElementById(heading);
                if (el) {
                    const rect = el.getBoundingClientRect();
                    if (rect.top <= 100) {
                        activeId = heading;
                    }
                }
            }

            document.querySelectorAll('#toc a').forEach(a => {
                if (a.getAttribute('href') === '#' + activeId) {
                    a.classList.add('active');
                } else {
                    a.classList.remove('active');
                }
            });
        }

        window.addEventListener('scroll', function() {
            updateProgress();
            updateBackToTop();
            updateActiveTOC();
        }, { passive: true });

        function loadPost() {
            if (slug) {
                loadNewFormat();
            } else {
                loadOldFormat();
            }
        }

        function loadNewFormat() {
            const bust = Date.now();
            const metaPath = '/posts/' + slug + '/meta.json?v=' + bust;
            const contentPath = '/posts/' + slug + '/content.md?v=' + bust;
            const visualPath = '/posts/' + slug + '/visual.html?v=' + bust;

            fetch(metaPath)
                .then(function(response) {
                    if (!response.ok) throw new Error('Meta not found');
                    return response.json();
                })
                .then(function(meta) {
                    postMeta = meta;
                    document.title = meta.title + " \u2014 Stary's Blog";

                    document.getElementById('header-title').textContent = meta.title;
                    document.getElementById('header-date').textContent = meta.date;
                    document.getElementById('header-description').textContent = meta.description || '';

                    var catEl = document.getElementById('header-category');
                    catEl.textContent = meta.category || '未分类';
                    catEl.className = 'category-badge ' + (categoryColors[meta.categoryColor] || 'category-blue');

                    if (meta.hasMd && meta.hasHtml) {
                        document.getElementById('mode-toggle').classList.add('visible');
                        showMD();
                    } else if (meta.hasHtml) {
                        document.getElementById('mode-toggle').classList.add('visible');
                        showHTML();
                    }

                    var promises = [];

                    if (meta.hasMd) {
                        promises.push(
                            fetch(contentPath)
                                .then(function(r) {
                                    if (!r.ok) throw new Error('Content not found');
                                    return r.text();
                                })
                                .then(function(markdown) {
                                    document.getElementById('header-readtime').textContent = estimateReadTime(markdown);
                                    var html = marked.parse(markdown);
                                    document.querySelector('#article .prose').innerHTML = html;
                                    generateTOC();
                                })
                        );
                    }

                    if (meta.hasHtml) {
                        promises.push(
                            fetch(visualPath)
                                .then(function(r) {
                                    if (!r.ok) throw new Error('Visual not found');
                                    return r.text();
                                })
                                .then(function(html) {
                                    document.getElementById('visual-iframe').srcdoc = html;
                                })
                        );
                    }

                    return Promise.all(promises);
                })
                .then(function() {
                    showContent();
                })
                .catch(function(error) {
                    showError(error.message);
                });
        }

        function loadOldFormat() {
            fetch('/posts/' + postPath)
                .then(function(response) {
                    if (!response.ok) throw new Error('Post not found');
                    return response.text();
                })
                .then(function(markdown) {
                    document.getElementById('header-readtime').textContent = estimateReadTime(markdown);
                    var html = marked.parse(markdown);
                    document.querySelector('#article .prose').innerHTML = html;

                    var h1 = document.querySelector('#article .prose h1');
                    if (h1) {
                        document.title = h1.textContent + " \u2014 Stary's Blog";
                        document.getElementById('header-title').textContent = h1.textContent;
                    }

                    generateTOC();
                    showContent();
                })
                .catch(function(error) {
                    showError(error.message);
                });
        }

        function generateTOC() {
            var headings = document.querySelectorAll('#article .prose h2, #article .prose h3');

            var tocList = document.getElementById('toc-list');
            tocList.innerHTML = '';
            var tocListMobile = document.getElementById('toc-list-mobile');
            tocListMobile.innerHTML = '';

            tocHeadings = [];

            if (headings.length === 0) {
                document.getElementById('toc-mobile').style.display = 'none';
                return;
            }

            headings.forEach(function(heading, index) {
                var id = 'heading-' + index;
                heading.id = id;
                tocHeadings.push(id);

                var link = document.createElement('a');
                link.href = '#' + id;
                link.textContent = heading.textContent;
                link.className = heading.tagName === 'H3' ? 'toc-h3' : 'toc-h2';

                var linkMobile = link.cloneNode(true);
                linkMobile.addEventListener('click', function() {
                    document.getElementById('toc-mobile-content').classList.remove('open');
                    document.getElementById('toc-chevron').classList.remove('rotate-180');
                });

                tocList.appendChild(link);
                tocListMobile.appendChild(linkMobile);
            });
        }

        function showContent() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');

            document.querySelectorAll('a[href^="#"]').forEach(function(anchor) {
                anchor.addEventListener('click', function(e) {
                    var href = this.getAttribute('href');
                    if (href !== '#') {
                        e.preventDefault();
                        var target = document.querySelector(href);
                        if (target) {
                            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }
                });
            });
        }

        function showError(msg) {
            document.getElementById('loading').innerHTML =
                '<div class="text-center">' +
                '<p class="text-zinc-500 mb-4">\u6587\u7AE0\u52A0\u8F7D\u5931\u8D25: ' + msg + '</p>' +
                '<a href="/" class="text-pink-500 hover:underline">\u8FD4\u56DE\u9996\u9875</a>' +
                '</div>';
        }

        loadPost();
    </script>
</body>
</html>
